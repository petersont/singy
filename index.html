<html>

<head>

<script src="jquery-2.1.0.min.js"></script>
<link rel=stylesheet type=text/css href="singy.css"/>

<script>

var g_audioCtx = null;

function init()
{
    var AudioContext = window.AudioContext || window.webkitAudioContext;
    g_audioCtx = new AudioContext();
    insertAvitar( $("#avitar-root"), "peter", 0 );
    insertAvitar( $("#avitar-root"), "lisa", 1 );

    var trackerRoot = $("#tracker-root");
    insertTracker( trackerRoot );
    initTrackerEventHandlers( trackerRoot );
    initTrackerCursor( trackerRoot )

    togglePlay();
}

var loadedBuffer = null;

var SoundPool = function()
{
    this.buffers = [null, null, null, null, null, null, null, null];
    this.index = 0;
}

SoundPool.prototype.add = function(buffer, trackIndex, finishedCallback)
{
    this.buffers[trackIndex] = {
        start: this.index,
        buffer: buffer,
        numSamples: buffer.length,
        finished: finishedCallback
    };
}

SoundPool.prototype.sample = function(array0, array1, arrayIndex)
{
    array0[arrayIndex] = 0;
    array1[arrayIndex] = 0;

    for(var i = 0; i < this.buffers.length; i++)
    {
        var buffer = this.buffers[i];
        if( buffer )
        {
            var start = buffer.start;
            var k = this.index-start;

            if( k < 0 )
            {
                continue;
            }

            if( k > buffer.numSamples )
            {
                buffer.finished();
                this.buffers[i] = null;
                continue;
            }

            var inarray = buffer.buffer.getChannelData(0);

            array0[arrayIndex] += inarray[k];
            array1[arrayIndex] += inarray[k];
        }
    }

    this.index++;
}

var g_soundPool = new SoundPool();

function process_from_buffer(evt)
{
    var array0 = evt.outputBuffer.getChannelData(0);
    var array1 = evt.outputBuffer.getChannelData(1);

    for( var i = 0; i < array0.length; i++ )
    {
        g_soundPool.sample(array0, array1, i);
    }
}

var g_node = null;

function start()
{
    g_node = g_audioCtx.createScriptProcessor(1024, 0, 2);
    g_index = 0;
    g_node.onaudioprocess = process_from_buffer;
    g_node.connect(g_audioCtx.destination);
}

function stop()
{
    g_node.disconnect();
}

var g_playing = false;
function togglePlay()
{
    if( g_playing )
    {
        stop();
        g_playing = false;
    }
    else
    {
        start();
        g_playing = true;
    }
}

function errorHandler(msg)
{
    return function()
    {
        console.log(msg);
    };
}

function loadSound(url, buffers)
{
    var request = new XMLHttpRequest();
    request.open('GET', url, true);
    request.responseType = 'arraybuffer';

    request.onload = function()
    {
        g_audioCtx.decodeAudioData(
            request.response,
            function(buffer)
            {
                buffers["A"] = buffer;
            },
            errorHandler("file not found: " + url)
        );
    }
    request.send();
}

function insertAvitar(container, name, trackIndex)
{
    var avitar = $('<div>').append(
        $('<div>').addClass("idle").append($('<img src = ' + 'images/' + name + '_idle.gif>')),
        $('<div>').addClass("singing").append($('<img src = ' + 'images/' +  name + '_singing.gif>'))
    );

    avitar.addClass("avitar");

    var buffers = {};

    loadSound("sounds/" + name + "_A.m4a", buffers);

    avitar.on('click',
        function()
        {
            avitar.addClass("playing");
            g_soundPool.add( buffers["A"], trackIndex,
                function()
                {
                    avitar.removeClass("playing");
                }
            );
        }
    );

    container.append( avitar );
}

function insertTracker(container)
{
    var tracker = $('<div id="baloney">').addClass('tracker');

    for( var j = 0; j < 16 * 4; j++ )
    {
        var column = $('<div>').addClass('column');
        for( var i = 0; i < 44; i++ )
            column.append( $('<div>').addClass('brick') );
        tracker.append(column);

        var d = 0;
        while( j%(1<<d) == 0 && d < 4 ) {d++;}

        column.css({borderLeftStyle:'solid', borderLeftWidth:'1px', borderLeftColor:
            {0:"#111", 1:"#222", 2:"#444", 3:"#666", 4:"#999", 5:"#eee"}[d-1] });
    }

    container.append( tracker );
}

function initTrackerEventHandlers(container)
{
    var color = 0;
    var mouseIsDown = false;

    function updateDisplayColor($brick)
    {
        if( $brick.data('color') )
            $brick.css({backgroundColor: '#f00'});
        else
            $brick.css({backgroundColor: 'rgba(20,20,20,0.5)'});
    }

    container.find('.brick').mousedown( function()
    {
        mouseIsDown = true;
        var currentColor = $(this).data('color') || 0;
        if( currentColor == 0 )
        {
            color = 1;
        }
        else
        {
            color = 0;
        }
        $(this).data('color', color);

        updateDisplayColor($(this));
    });

    container.find('.tracker').on('mouseleave', function(evt)
    {
        color = 0;
        mouseIsDown = false;
    });

    container.find('.tracker').on('mouseup', function(evt)
    {
        color = 0;
        mouseIsDown = false;
    });

    container.find('.brick').mouseup( function()
    {
        color = 0;
        mouseIsDown = false;
        updateDisplayColor($(this));
    });

    container.find('.brick').mouseenter( function()
    {
        if( mouseIsDown )
        {
            $(this).data('color', color);
            updateDisplayColor($(this));
        }
    });
}

function initTrackerCursor(container)
{
    var cursorPosition = 0;

    $(document).on('keydown', function(evt)
    {
        if( evt.keyCode == 32 )
        {
            var columns = container.find('div.column');
            columns.removeClass('cursor-glow');
            columns.eq(cursorPosition).addClass('cursor-glow');

            cursorPosition++;
            if( cursorPosition > columns.length )
            {
                cursorPosition = 0;
            }
        }
    });
}


</script>


</head>

<body onload="init();">
<div id="avitar-root"></div>
<div id="tracker-root"></div>
</body>

</html>

