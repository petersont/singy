
<html>

<head>

<script src="jquery-2.1.0.min.js"></script>

<script>

var g_audioCtx = null;

function init()
{
    var AudioContext = window.AudioContext || window.webkitAudioContext;
    g_audioCtx = new AudioContext();
    insertAvitar( "peter", 0 );
    insertAvitar( "lisa", 1 );

    togglePlay();
}

var loadedBuffer = null;

var SoundPool = function()
{
    this.buffers = [null, null, null, null, null, null, null, null];
    this.index = 0;
}

SoundPool.prototype.add = function(buffer, trackIndex, finishedCallback)
{
    this.buffers[trackIndex] = {
        start: this.index,
        buffer: buffer,
        numSamples: buffer.length,
        finished: finishedCallback
    };
}

SoundPool.prototype.sample = function(array0, array1, arrayIndex)
{
    array0[arrayIndex] = 0;
    array1[arrayIndex] = 0;

    for(var i = 0; i < this.buffers.length; i++)
    {
        var buffer = this.buffers[i];
        if( buffer )
        {
            var start = buffer.start;
            var k = this.index-start;

            if( k < 0 )
            {
                continue;
            }

            if( k > buffer.numSamples )
            {
                buffer.finished();
                this.buffers[i] = null;
                continue;
            }

            var inarray = buffer.buffer.getChannelData(0);

            array0[arrayIndex] += inarray[k];
            array1[arrayIndex] += inarray[k];
        }
    }

    this.index++;
}

var g_soundPool = new SoundPool();

function process_from_buffer(evt)
{
    var array0 = evt.outputBuffer.getChannelData(0);
    var array1 = evt.outputBuffer.getChannelData(1);

    for( var i = 0; i < array0.length; i++ )
    {
        g_soundPool.sample(array0, array1, i);
    }
}

var g_node = null;

function start()
{
    g_node = g_audioCtx.createScriptProcessor(1024, 0, 2);
    g_index = 0;
    g_node.onaudioprocess = process_from_buffer;
    g_node.connect(g_audioCtx.destination);
}

function stop()
{
    g_node.disconnect();
}

var g_playing = false;
function togglePlay()
{
    if( g_playing )
    {
        stop();
        g_playing = false;
    }
    else
    {
        start();
        g_playing = true;
    }
}

function onError()
{
    debugger;
}

function loadSound(url, buffers)
{
    var request = new XMLHttpRequest();
    request.open('GET', url, true);
    request.responseType = 'arraybuffer';

    request.onload = function()
    {
        g_audioCtx.decodeAudioData(
            request.response,
            function(buffer)
            {
                buffers["A"] = buffer;
            },
            onError
        );
    }
    request.send();
}

function insertAvitar(name, trackIndex)
{
    var avitar = $('<div>').append(
        $('<div>').addClass("idle").append($('<img src = ' + name + '_idle.gif>')),
        $('<div>').addClass("singing").append($('<img src = ' + name + '_singing.gif>'))
    );

    avitar.addClass("avitar");

    var buffers = {};

    loadSound(name + "_A.m4a", buffers);

    avitar.on('click',
        function()
        {
            avitar.addClass("playing");
            g_soundPool.add( buffers["A"], trackIndex,
                function()
                {
                    avitar.removeClass("playing");
                }
            );
        }
    );

    $("#root").append( avitar );
}


</script>

<style>
body {
    background-color: #000;
}

.avitar .idle {
    display: inline-block;
}

.avitar .singing {
    display: none;
}

.playing.avitar .idle {
    display: none;
}

.playing.avitar .singing {
    display: inline-block;
}

</style>

</head>

<body onload="init();">
<div id="root"></div>
</body>


</html>

